<% layout("/layouts/boilerplate") %>

<div class="row show-container">
  <div class="col-8 offset-3">
    <h3><b><%=listing.title%></b></h3>
  </div>
  <div class="card col-6 offset-3 show-card listing-card">
    <img
      src="<%= listing.image.url %>"
      class="card-img-top show-img"
      alt="Listing_image"
    />
    <div class="card-body">
      <p class="card-text">Owned by <i><%= listing.owner ? listing.owner.username : 'Unknown' %></i></p>
      <p class="card-body"><%=listing.description%></p>
      <p class="card-body">
        &#8377; <%=listing.price.toLocaleString("en-IN")%> / night
      </p>
      <p class="card-body"><%=listing.location%>, <%=listing.country%></p>
    </div>
  </div>

  <% if(currUser && listing.owner && listing.owner._id.equals(currUser._id)){%>
  <div class="btns">
    <a
      href="/listings/<%=listing._id%>/edit"
      class="btn btn-dark col-1 offset-3 edit-btn"
    >
      <svg height="16" width="16" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 1024 1024">
        <path fill="currentColor" d="M799.4 314.9l-90.5-90.5c-12.5-12.5-32.8-12.5-45.3 0L516.2 371.8c-6.2 6.2-6.2 16.4 0 22.6l90.5 90.5c6.2 6.2 16.4 6.2 22.6 0l147.4-147.4c12.5-12.5 12.5-32.8 0-45.3zM416 672H262.4c-8.8 0-16-7.2-16-16V502.4c0-4.2 1.7-8.3 4.7-11.3l267.6-267.6c6.2-6.2 16.4-6.2 22.6 0l90.5 90.5c6.2 6.2 6.2 16.4 0 22.6L364.7 603.7c-3 3-7.1 4.7-11.3 4.7H262.4V672h153.6c8.8 0 16 7.2 16 16v64c0 8.8-7.2 16-16 16z"></path>
      </svg>
      Edit
    </a>

    <form method="post" action="/listings/<%=listing._id%>?_method=DELETE" class="del">
      <button>Delete</button>
    </form>
  </div>
  <% } %>

  <div class="col-8 offset-3 mb-3 review-sec">
    <% if(currUser){ %>
    <hr />
    <h4>Leave a Review</h4>
    <form
      method="POST"
      action="/listings/<%=listing._id%>/reviews"
      novalidate
      class="needs-validation"
    >
      <div class="mb-3 mt-3">
        <label for="rating" class="form-label">Rating</label>
        <fieldset class="starability-slot">
          <input
            type="radio"
            id="no-rate"
            class="input-no-rate"
            name="review[rating]"
            value="1"
            checked
            aria-label="No rating."
          />
          <input type="radio" id="first-rate1" name="review[rating]" value="1" />
          <label for="first-rate1" title="Terrible">1 star</label>
          <input type="radio" id="first-rate2" name="review[rating]" value="2" />
          <label for="first-rate2" title="Not good">2 stars</label>
          <input type="radio" id="first-rate3" name="review[rating]" value="3" />
          <label for="first-rate3" title="Average">3 stars</label>
          <input type="radio" id="first-rate4" name="review[rating]" value="4" />
          <label for="first-rate4" title="Very good">4 stars</label>
          <input type="radio" id="first-rate5" name="review[rating]" value="5" />
          <label for="first-rate5" title="Amazing">5 stars</label>
        </fieldset>
      </div>
      <div class="mb-3 mt-3">
        <label for="comment" class="form-label">Comments</label>
        <textarea
          name="review[comment]"
          id="comment"
          cols="30"
          rows="5"
          class="form-control"
          required
        ></textarea>
        <div class="invalid-feedback">Please add some comments for review</div>
      </div>
      <button class="btn btn-outline-dark">Submit</button>
    </form>
    <hr />
    <% } %>

    <% if(listing.reviews.length > 0) { %>
    <div class="row">
      <p><b>All Reviews</b></p>
      <% for(review of listing.reviews){%>
      <div class="card col-5 ms-3 mb-3 review-card">
        <div class="card-body">
          <h5 class="card-title">@<%= review.author ? review.author.username : 'Anonymous' %></h5>
          <p
            class="starability-result card-text"
            data-rating="<%=review.rating%>"
          ></p>
          <p class="card-text"><%=review.comment%></p>

          <% if(currUser && review.author && review.author._id.equals(currUser._id)) { %>
          <form
            class="mb-3"
            method="POST"
            action="/listings/<%=listing._id%>/reviews/<%=review._id%>?_method=DELETE"
          >
            <button class="review-btn">
              <svg class="icon" viewBox="0 0 448 512" height="1em" xmlns="http://www.w3.org/2000/svg">
                <path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"></path>
              </svg>
            </button>
          </form>
          <% } %>
        </div>
      </div>
      <%}%>
    </div>
    <% } %>
  </div>

  <div class="col-8 offset-3 mb-3">
    <h3>Where you'll be</h3>
    <div id="map"></div>
  </div>
</div>

<!-- ensure Mapbox CSS/JS are available (remove if already in layout) -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.19.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.19.0/mapbox-gl.js"></script>

<script>
  // Wait for DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMap);
  } else {
    initMap();
  }

  function initMap() {
    const mapToken = "<%= process.env.MAPBOX_TOKEN || process.env.MAP_TOKEN || '' %>";
    if (!mapToken) {
      console.error('Mapbox token not set. Set MAPBOX_TOKEN or MAP_TOKEN in .env');
      return;
    }

    if (typeof mapboxgl === 'undefined') {
      console.error('Mapbox GL JS not loaded');
      return;
    }

    // ensure geometry exists
    const listingData = JSON.parse('<%- JSON.stringify({ title: listing.title, coordinates: listing.geometry ? listing.geometry.coordinates : null }).replace(/'/g, "\\'") %>');
    if (!listingData.coordinates || !Array.isArray(listingData.coordinates)) {
      console.error('Listing geometry missing or invalid:', listingData);
      return;
    }

    mapboxgl.accessToken = mapToken;

    try {
      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: listingData.coordinates,
        zoom: 9
      });

      map.addControl(new mapboxgl.NavigationControl());
      map.scrollZoom.disable();

      map.on('load', () => {
        const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`<h5>${listingData.title}</h5>`);
        new mapboxgl.Marker({ color: 'red' })
          .setLngLat(listingData.coordinates)
          .setPopup(popup)
          .addTo(map);
      });

      map.on('error', (e) => console.error('Map error:', e));
    } catch (err) {
      console.error('Error creating map:', err);
    }
  }
</script>